#!/bin/bash

# Print commands as executed and fail on error
set -ex

# Test inside-git build system
mkdir build
cd build

CMAKE_PARAMETERS="-DCMAKE_VERBOSE_MAKEFILE=ON"

CMAKE_PARAMETERS+=" -DCMAKE_BUILD_TYPE=Debug"

# OSX specific stuff
if [ "$TRAVIS_OS_NAME" = "osx" ] ; then
	# Use prerendered PDF
	# rather than install pdflatex
	CMAKE_PARAMETERS+=" -DUsePrerenderedPDF=ON"

	# Skip dual screen tests since we don't have
	# xvfb-run
	CMAKE_PARAMETERS+=" -DRunDualScreenTests=OFF"
fi

# Activate code coverage analysis
CMAKE_PARAMETERS+=" -DCodeCoverage=ON"

# Allow switching Qt version via environment variable
if [ "$QT_VERSION" -eq 4 ] ; then
	CMAKE_PARAMETERS+=" -DUseQtFive=OFF"
elif [ "$QT_VERSION" -eq 5 ] ; then
	CMAKE_PARAMETERS+=" -DUseQtFive=ON"
else
	echo "Unknown qt version $QT_VERSION" >&2
	false
fi

# travis/ccache hack for clang
if [[ "$CXX" == "clang++" && -x /usr/bin/ccache ]] ; then
	mkdir -p /home/travis/bin
	ln -s /usr/bin/ccache /home/travis/bin/clang
	ln -s /usr/bin/ccache /home/travis/bin/clang++
	export PATH=/home/travis/bin:$PATH
fi

cmake $CMAKE_PARAMETERS ..
