version: '{build}'
branches:
  only:
  - master
  - /^windows-test.*/
os: Visual Studio 2013

# Before build: Download and extract dependency package
before_build:
  # Allow password-based authentication to RDP
  # this is needed for rdesktop to work later on
- cmd: reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v UserAuthentication /t REG_DWORD /d 0 /f
  # Download and extract dependencies
- ps: (new-object net.webclient).DownloadFile('https://github.com/projekter/dspdfviewer/releases/download/v1.14-42-g4acfb31/DependenciesDyn.rar', 'c:\dependencies.rar')
- cmd: cd \
- cmd: 7z x \dependencies.rar

# Build with cmake
build_script:
- cmd: cd \projects\dspdfviewer
- cmd: mkdir build
- cmd: cd build
- cmd: >
    cmake ..
    -G "Visual Studio 12 2013"
    -DUseQtFive=ON
    -DDownloadTestPDF=ON
    -DCMAKE_VERBOSE_MAKEFILE=ON
    -DBoostStaticLink=ON
    -DWindowsStaticLink=OFF
    -DBOOST_ROOT=\libraries\boost
    -DBOOST_LIBRARYDIR=\libraries\boost\lib32-msvc-12.0
- cmd: cmake --build . --config Release

before_test:
    - cmd: SET PATH=%PATH%;C:\dspdf\popplerDyn\deps\cairo\bin
    - cmd: SET PATH=%PATH%;C:\dspdf\popplerDyn\deps\expat\bin
    - cmd: SET PATH=%PATH%;C:\dspdf\popplerDyn\deps\fontconfig\lib
    - cmd: SET PATH=%PATH%;C:\dspdf\popplerDyn\deps\freetype\bin
    - cmd: SET PATH=%PATH%;C:\dspdf\popplerDyn\deps\lcms\lib\MS
    - cmd: SET PATH=%PATH%;C:\dspdf\popplerDyn\deps\libiconv\lib
    - cmd: SET PATH=%PATH%;C:\dspdf\popplerDyn\deps\libjpeg-turbo\bin
    - cmd: SET PATH=%PATH%;C:\dspdf\popplerDyn\deps\libpng\bin
    - cmd: SET PATH=%PATH%;C:\dspdf\popplerDyn\deps\libtiff\bin
    - cmd: SET PATH=%PATH%;C:\dspdf\popplerDyn\deps\openjpeg\bin
    - cmd: SET PATH=%PATH%;C:\dspdf\popplerDyn\deps\zlib\bin
    - cmd: SET PATH=%PATH%;C:\dspdf\popplerDyn\poppler\bin
    - cmd: SET PATH=%PATH%;C:\qt\5.5\msvc2013\bin

test_script:
    - cmd: ctest -C Release --output-on-failure --timeout 30

# Un-Comment this to get an RDP shell when something fails
#on_failure:
#    - ps: '$blockRdp = $true; iex ((new-object net.webclient).DownloadString(''https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1''))'
